````markdown
---
description: 在任務生成後，對 spec.md、plan.md 和 tasks.md 進行非破壞性的跨產物一致性和品質分析。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

## 使用者輸入

```text
$ARGUMENTS
```

在繼續之前，您**必須**考慮使用者輸入（如果不為空）。

## 目標

在實作之前，識別三個核心產物（`spec.md`、`plan.md`、`tasks.md`）之間的不一致性、重複、歧義和規格不足的項目。此命令**必須**只在 `/tasks` 成功產生完整的 `tasks.md` 之後執行。

## 操作限制

**嚴格唯讀**：**不要**修改任何檔案。輸出結構化的分析報告。提供可選的修復計畫（使用者必須明確同意，然後才能手動調用任何後續編輯命令）。

**憲章權威**：專案憲章（`/memory/constitution.md`）在此分析範圍內是**不可協商的**。憲章衝突自動為關鍵，需要調整規格、計畫或任務——而非稀釋、重新解釋或默默忽略原則。如果原則本身需要改變，那必須在 `/analyze` 之外的單獨、明確的憲章更新中進行。

## 執行步驟

### 1. 初始化分析內容

從儲存庫根目錄執行 `{SCRIPT}` 一次，並解析 JSON 以取得 FEATURE_DIR 和 AVAILABLE_DOCS。推導絕對路徑：

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

如果任何必要檔案遺失，則以錯誤訊息中止（指導使用者執行遺失的先決條件命令）。

### 2. 載入產物（漸進披露）

只從每個產物載入最少的必要內容：

**從 spec.md：**

- 概述/內容
- 功能需求
- 非功能需求
- 使用者故事
- 邊緣情況（如果存在）

**從 plan.md：**

- 架構/堆疊選擇
- 資料模型參考
- 階段
- 技術約束

**從 tasks.md：**

- 任務 ID
- 描述
- 階段分組
- 平行標記 [P]
- 參考檔案路徑

**從憲章：**

- 載入 `/memory/constitution.md` 進行原則驗證

### 3. 建立語義模型

建立內部表示（不在輸出中包含原始產物）：

- **需求清單**：每個功能 + 非功能需求具有穩定的鍵（基於命令式短語推導縮寫；例如，「使用者可以上傳檔案」→ `user-can-upload-file`）
- **使用者故事/動作清單**：具有驗收標準的離散使用者動作
- **任務覆蓋對應**：將每個任務對應到一個或多個需求或故事（透過關鍵詞 / 明確參考模式如 ID 或關鍵短語進行推論）
- **憲章規則集**：提取原則名稱和 MUST/SHOULD 規範性陳述

### 4. 檢測通道（符記高效分析）

專注於高信號發現。限制總共 50 個發現；將其餘的聚合在溢出摘要中。

#### A. 重複檢測

- 識別近似重複的需求
- 標記較低品質的措辭以進行整合

#### B. 歧義檢測

- 標記缺乏可測量標準的模糊形容詞（快速、可擴展、安全、直觀、強健）
- 標記未解決的佔位符（TODO、TKTK、???、`<placeholder>` 等）

#### C. 規格不足

- 具有動詞但缺少物件或可測量結果的需求
- 缺少驗收標準對齊的使用者故事
- 任務參考規格/計畫中未定義的檔案或元件

#### D. 憲章對齊

- 任何與必須原則衝突的需求或計畫元素
- 憲章中遺失的強制區段或品質關卡

#### E. 覆蓋差距

- 沒有關聯任務的需求
- 沒有對應需求/故事的任務
- 未在任務中反映的非功能需求（例如，效能、安全性）

#### F. 不一致性

- 術語漂移（相同概念在檔案間以不同名稱命名）
- 計畫中參考但規格中缺少的資料實體（或反之）
- 任務順序矛盾（例如，整合任務在基礎設置任務之前而沒有依賴注釋）
- 衝突需求（例如，一個需要 Next.js 而另一個指定 Vue）

### 5. 嚴重性分配

使用此啟發式來優先排序發現：

- **關鍵**：違反憲章必須、遺失核心規格產物，或阻礙基線功能的零覆蓋需求
- **高**：重複或衝突需求、模糊的安全性/效能屬性、無法測試的驗收標準
- **中**：術語漂移、遺失的非功能任務覆蓋、規格不足的邊緣情況
- **低**：風格/措辭改進、不影響執行順序的輕微冗餘

### 6. 產生緊湊分析報告

輸出具有以下結構的 Markdown 報告（無檔案寫入）：

## 規格分析報告

| ID | 類別 | 嚴重性 | 位置 | 摘要 | 建議 |
|----|------|--------|------|-----|------|
| A1 | 重複 | 高 | spec.md:L120-134 | 兩個相似需求... | 合併措辭；保留更清晰版本 |

（每個發現添加一行；生成以類別首字母為前綴的穩定 ID。）

**覆蓋摘要表格：**

| 需求鍵 | 有任務？ | 任務 ID | 注釋 |
|--------|----------|---------|------|

**憲章對齊問題：**（如果有的話）

**未對應任務：**（如果有的話）

**指標：**

- 總需求數
- 總任務數
- 覆蓋率 %（具有 ≥1 個任務的需求）
- 歧義計數
- 重複計數
- 關鍵問題計數

### 7. 提供下一步行動

在報告末尾，輸出簡潔的下一步行動區塊：

- 如果存在關鍵問題：建議在 `/implement` 之前解決
- 如果只有低/中等問題：使用者可以繼續，但提供改進建議
- 提供明確的命令建議：例如，「執行 /specify 進行細化」、「執行 /plan 調整架構」、「手動編輯 tasks.md 以為『performance-metrics』添加覆蓋」

### 8. 提供修復

詢問使用者：「您希望我為前 N 個問題建議具體的修復編輯嗎？」（不要自動應用它們。）

## 操作原則

### 內容效率

- **最少的高信號符記**：專注於可操作的發現，而非詳盡的文件
- **漸進披露**：逐步載入產物；不要將所有內容傾倒到分析中
- **符記高效輸出**：限制發現表格為 50 行；摘要溢出
- **確定性結果**：在沒有變更的情況下重新執行應產生一致的 ID 和計數

### 分析指南

- **絕不修改檔案**（這是唯讀分析）
- **絕不幻想遺失的區段**（如果缺少，準確報告它們）
- **優先考慮憲章違規**（這些總是關鍵的）
- **使用範例而非詳盡規則**（引用具體實例，而非通用模式）
- **優雅地報告零問題**（發出帶有覆蓋統計的成功報告）

## 內容

{ARGS}
